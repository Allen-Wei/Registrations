@{
    ViewBag.Title = "New";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section header{
    <style type="text/css">
        .new-form {
        }

        .new-form .col-xs-12 {
            margin-top: 10px;
            vertical-align: middle;
        }
        /*for form.html, detai.html*/
        .header-sub {
            color: #aaa;
        }

        .header-sub:after {
            /*content: ':';*/
        }
    </style>
}


<div ng-app="Registration">
    <div ng-controller="BodyCtrl">
        <div ng-view></div>
    </div>
</div>


<script>
    var app = angular.module('Registration', ['ngRoute', 'registration.services', 'registration.directives', 'registration.filters']);
    app.config(function ($routeProvider) {
        $routeProvider.when('/', {
            controller: 'ListCtrl',
            templateUrl: '/Partials/Education/list.html'
        }).when('/detail/:id', {
            controller: 'DetailCtrl',
            templateUrl: '/Partials/Education/detail.html'
        }).when('/edit/:id', {
            controller: 'FormCtrl',
            templateUrl: '/Partials/Education/form.html'
        }).when('/new', {
            controller: 'FormCtrl',
            templateUrl: '/Partials/Education/form.html'
        }).when('/print/:id', {
            controller: 'PrintCtrl',
            templateUrl: '/Partials/Education/print.html'
        }).otherwise({
            redirectTo: '/'
        });
    });

    app.factory('RegSvc', function ($http, AppConstant) {
        var service = {
            loadColleges: function () {
                var promise = $http({
                    method: 'get',
                    url: '/APIv1/College'
                });
                return promise;
            }
            , add: function (reg) {
                var promise = $http({
                    method: 'put',
                    url: '/APIv1/Registration',
                    data: reg
                });
                return promise;
            }
            , loadRegList: function (page) {
                var take = AppConstant.perPage;
                var skip = (page - 1) * take;
                var promise = $http({
                    method: 'get',
                    url: '/APIv1/Registration',
                    params: { take: take, skip: skip }
                });
                return promise;
            }
            , getDetail: function (id) {
                var promise = $http({
                    method: 'get',
                    url: '/APIv1/Registration/' + id
                });
                return promise;
            }
            , update: function (reg) {
                var promise = $http({
                    method: 'post',
                    url: '/APIv1/Registration',
                    data: reg
                });
                return promise;
            }
            , remove: function (id) {
                var promise = $http({
                    method: 'delete',
                    url: '/APIv1/Registration/' + id
                });
                return promise;
            }
            , loadCourseCategories: function () {
                var promise = $http({
                    method: 'get',
                    url: '/APIv1/CourseCategory'
                });
                return promise;
            }
            , loadCourses: function (categoryName) {
                var promise = $http({
                    method: 'get',
                    url: '/APIv1/Course?category=' + categoryName
                });
                return promise;
            }
        };
        return service;
    });




    app.controller('BodyCtrl', function ($scope, AppConstant) {
        $scope.constant = AppConstant;
    });
    app.controller('ListCtrl', function ($scope, RegSvc) {

        $scope.main = {
            regs: [],
            page: 1,
            pages: 1,
            total: 1,
            load: function (p) {
                RegSvc.loadRegList(p).then(function (rep) {
                    $scope.main.regs = rep.data;
                    $scope.main.pages = parseInt(rep.headers('X-HeyHey-Pages'));
                    $scope.main.total = parseInt(rep.headers('X-HeyHey-Total'));
                });
            },
            remove: function (index) {
                var reg = this.regs[index];
                if (!reg) {
                    throw 'Cannot find ' + index;
                }

                RegSvc.remove(reg.Id).then(function (rep) {
                    if (rep.data) {
                        $scope.main.regs.splice(index, 1);
                    }
                }, function (rep) {
                    console.log('deleted fail.');
                });
            }
        };

        $scope.$watch('main.page', function (newVal, oldVal) {
            if (newVal <= 0) {
                throw 'Erro page number: ' + newVal;
            }
            if (newVal > $scope.main.pages) {
                throw 'Out of max pages: ' + newVal;
            }
            $scope.main.load(newVal);
        });
    });
    app.controller('DetailCtrl', function ($scope, $routeParams, RegSvc) {
        $scope.main = {
            reg: {}
        };
        RegSvc.getDetail($routeParams.id).then(function (rep) {
            $scope.main.reg = rep.data;
        });
    });
    app.controller('PrintCtrl', function ($scope, RegSvc, $routeParams) {
        $scope.main = {
            reg: {}
        };
        RegSvc.getDetail($routeParams.id).then(function (rep) {
            $scope.main.reg = rep.data;
        });
    });
    app.controller('FormCtrl', function ($scope, $http, $filter, AppConstant, RegSvc, $location, $routeParams) {
        $scope.main = {
            mode: 'add',
            reg: {
                StudentName: '',
                Gender: 'true',
                Phone: '',
                Phone2: '',
                LiveAddress: '',
                HomeAddress: '',

                ReceiptNumber: '',
                RegistrateDate: $filter('date')(new Date(), AppConstant.ngDateFormat),
                Price: 0,
                Payee: '',

                RegistrationAddress: 'zongbu',
                CourseCategoryName: '',
                CourseName: '',
                CurrentCollege: '',
                RegistrateCollege: '',
                CurrentGrade: 'dayi',
                EducationDegree: 'zhuanke',
                Note: ''
            }
            , colleges: {
                choices: [],
                all: []
            }
            , courseAssist: {
                categories: [],
                category: {},
                courses: [],
                course: {}
            }
            , submit: function () {

                this.reg.CourseCategoryName = this.courseAssist.category.Name;
                this.reg.CourseName = this.courseAssist.course.Name;

                if (this.mode == 'update') {
                    RegSvc.update(this.reg).then(function () {
                        $location.path('/');
                    });
                } else {
                    RegSvc.add(this.reg).then(function (rep) {
                        $location.path('/detail/' + rep.data.Id);
                    });

                }
            }
        };

        //Course category change, load Course
        $scope.$watch('main.courseAssist.category.Name', function (newVal, oldVal) {
            if (newVal === undefined) { return; }
            RegSvc.loadCourses(newVal).then(function (rep) {
                $scope.main.courseAssist.courses = rep.data;
                $scope.main.courseAssist.course = $scope.main.courseAssist.courses[0];
            });
        });

        (function () {
            if ($routeParams.id) {
                $scope.main.mode = 'update';
            } else {
                $scope.main.mode = 'add';
            }

            if ($scope.main.mode == 'update') {
                //update mode
                //load registration data
                RegSvc.getDetail($routeParams.id).then(function (rep) {
                    $scope.main.reg = rep.data;
                    $scope.main.reg.RegistrateDate = $filter('date')(rep.data.RegistrateDate, AppConstant.ngDateFormat);
                    $scope.main.reg.Gender = rep.data.Gender.toString();
                });
            }

            //load course category
            RegSvc.loadCourseCategories().then(function (rep) {
                $scope.main.courseAssist.categories = rep.data;
                $scope.main.courseAssist.category = $scope.main.courseAssist.categories[0];
            });


            //load all colleges
            RegSvc.loadColleges().then(function (rep) {
                angular.forEach(rep.data, function (college) {
                    $scope.main.colleges.all.push(college.Name);
                    if (college.CanRegistrate) {
                        $scope.main.colleges.choices.push(college.Name);
                    }
                });
                $scope.main.reg.CurrentCollege = $scope.main.colleges.all[0];
                $scope.main.reg.RegistrateCollege = $scope.main.colleges.choices[0];
            });
        })();



    });
</script>